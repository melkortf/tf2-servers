ARG REGISTRY=ghcr.io
ARG TF2_BASE_TAG=latest
ARG ARCH=i386

FROM ubuntu:22.04 AS plugins
WORKDIR /download
ARG INSTALL_DIR=/server/tf
RUN mkdir -p "${INSTALL_DIR}"

ARG METAMOD_VERSION=1.12.0-git1219
ARG METAMOD_FILE_NAME=mmsource-${METAMOD_VERSION}-linux.tar.gz
ARG METAMOD_URL=https://mms.alliedmods.net/mmsdrop/1.12/${METAMOD_FILE_NAME}
ARG METAMOD_CHECKSUM=f16e67d8de30a46edb2aee8909a885f9f025993284596bb0cfc83b5b32eae05f
ADD --checksum=sha256:${METAMOD_CHECKSUM} ${METAMOD_URL} .
RUN tar xf "${METAMOD_FILE_NAME}" -C "${INSTALL_DIR}/"

ARG SOURCEMOD_VERSION=1.12.0-git7209
ARG SOURCEMOD_TARBALL_FILE_NAME=sourcemod-${SOURCEMOD_VERSION}-linux.tar.gz
ARG SOURCEMOD_TARBALL_URL=https://sm.alliedmods.net/smdrop/1.12/${SOURCEMOD_TARBALL_FILE_NAME}
ARG SOURCEMOD_CHECKSUM=0e39fe8acbf0edd0ee7e6f95874a06bdb3c47038e2276a055a33f00ab6c1fe33
ADD --checksum=sha256:${SOURCEMOD_CHECKSUM} ${SOURCEMOD_TARBALL_URL} .
RUN tar xf "${SOURCEMOD_TARBALL_FILE_NAME}" -C "${INSTALL_DIR}/"

FROM ${REGISTRY}/melkortf/tf2-base/${ARCH}:${TF2_BASE_TAG}
LABEL maintainer="garrappachc@gmail.com"

ARG INSTALL_DIR=/server/tf
COPY --from=plugins --chown=tf2 "${INSTALL_DIR}/" "${SERVER_DIR}/tf/"
